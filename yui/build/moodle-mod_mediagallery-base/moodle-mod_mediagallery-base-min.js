YUI.add("moodle-mod_mediagallery-base",function(r,e){M.mod_mediagallery=M.mod_mediagallery||{},M.mod_mediagallery.base={defaultitemwidth:187,courseid:0,mid:0,gallery:0,lbg_setup_ran:!1,options:{enablecomments:!1,enablelikes:!1,mode:"standard"},uri:M.cfg.wwwroot+"/mod/mediagallery/rest.php",init:function(e,t,o,a,i,l){this.courseid=e,this.mid=t,this.gallery=i,l&&l.enablecomments&&(this.options.enablecomments=!0),l&&l.enablelikes&&(this.options.enablelikes=!0),l&&l.mode&&(this.options.mode=l.mode),!a&&"gallery"!==o||("thebox"!==this.options.mode?this.watch_editing_buttons(o):this.watch_delete_thebox(o)),0===i&&"gallery"===o&&this.add_remove_collection_handler(),a||this.watch_mediasize(),this.setup_sample_link(),this.watch_resize()},add_remove_collection_handler:function(){var o,a,i,e=r.one(".collection.actions .remove");e&&(o=e.hasClass("owner"),a={title:M.str.mod_mediagallery.confirmcollectiondelete,question:M.str.mod_mediagallery.removecollectionconfirm,yesLabel:M.str.moodle.submit,noLabel:M.str.moodle.cancel,closeButtonTitle:M.str.moodle.cancel},i={"class":"collection",id:this.mid},this._confirmationListener=this._confirmationListener||e.on("click",function(e){var t;e.preventDefault(),o?(e=M.str.mod_mediagallery.deleteorremovecollection,e=(e+='<br/><input type="textbox" name="deleteorremove"/><br/>')+M.str.mod_mediagallery.deleteorremovecollectionwarn,a.question='<div class="deleteorremove">'+e+"</div>",(t=new M.core.confirm(a)).on("complete-yes",function(){i.action="remove";var e=r.one('input[name="deleteorremove"]');if(e)if("DELETE"===e.get("value").toUpperCase())i.action="delete";else if(""!==e.get("value"))return;this._confirmationListener.detach(),M.mod_mediagallery.base.delete_object(i)},this)):(t=new M.core.confirm(a),i.action="remove",t.on("complete-yes",function(){this._confirmationListener.detach(),M.mod_mediagallery.base.delete_object(i)},this)),t.show()},this))},watch_delete_thebox:function(a){var i="item"===a?".item":".gallery_list_item",l={title:M.str.mod_mediagallery["confirm"+a+"delete"],yesLabel:M.str.moodle.submit,noLabel:M.str.moodle.cancel,closeButtonTitle:M.str.moodle.cancel};r.all(i+" .controls .delete").each(function(){this._confirmationListener=this._confirmationListener||this.on("click",function(e){var t,o;e.preventDefault(),e=this.hasClass("owner"),(t=this.ancestor("div"+i).getData())["class"]=a,e?(e=M.str.mod_mediagallery["deleteorremove"+a],e=(e+='<br/><input type="textbox" name="deleteorremove"/><br/>')+M.str.mod_mediagallery["deleteorremove"+a+"warn"],l.question='<div class="deleteorremove">'+e+"</div>",(o=new M.core.confirm(l)).on("complete-yes",function(){t.action="remove";var e=r.one('input[name="deleteorremove"]');if(e)if("DELETE"===e.get("value").toUpperCase())t.action="delete";else if(""!==e.get("value"))return;this._confirmationListener.detach(),M.mod_mediagallery.base.delete_object(t,i)},this)):(l.question=M.str.mod_mediagallery["remove"+a+"confirm"],o=new M.core.confirm(l),t.action="remove",o.on("complete-yes",function(){this._confirmationListener.detach(),M.mod_mediagallery.base.delete_object(t,i)},this)),o.show()},this)})},watch_editing_buttons:function(o){var a="item"===o?".item":".gallery_list_item",i={title:M.str.mod_mediagallery["confirm"+o+"delete"],origquestion:M.str.mod_mediagallery["delete"+o]+" ",yesLabel:M.str.moodle.yes,noLabel:M.str.moodle.cancel,closeButtonTitle:M.str.moodle.cancel};r.all(a+" .controls .delete").each(function(){this._confirmationListener=this._confirmationListener||this.on("click",function(e){var t;e.preventDefault(),t=this.ancestor("div"+a).getData(),i.question=i.origquestion+t.title+"?",(e=new M.core.confirm(i)).on("complete-yes",function(){this._confirmationListener.detach(),t["class"]=o,M.mod_mediagallery.base.delete_object(t,a)},this),e.show()},this)})},watch_mediasize:function(){var e=".mediasize_selector select";r.one(e)&&r.one(e).on("change",function(e){var t,o,a;e.preventDefault(),(t=r.one(".gallery")).removeClass("small"),t.removeClass("large"),a="","0"===(o=e.target.get("value"))?a="small":"2"===o&&(a="large"),""!==a&&t.addClass(a),require(["core_user/repository"],function(e){e.setUserPreference("mod_mediagallery_mediasize",o)})})},add_gallery_info_modal:function(e,t){var o,a=r.Node.create('<div class="metainfo"></div>'),i='<a href="'+M.cfg.wwwroot+"/user/view.php?id="+t.userid;i+="&course="+e+'">'+t.firstname+" "+t.lastname+"</a>",e=[[M.str.mod_mediagallery.galleryname,t.name],[M.str.mod_mediagallery.creator,i]],null!==t.groupname&&e.push([M.str.moodle.group,t.groupname]),r.each(e,function(e){r.Node.create('<div class="field">'+e[0]+'</div><div class="value">'+e[1]+"</div>").appendTo(a)}),o={headerContent:M.str.mod_mediagallery.information,bodyContent:a,modal:!0},r.one(".gallery_list_item[data-id="+t.id+"] .action-icon.info").on("click",function(e){e.preventDefault(),new M.core.dialogue(o).show()})},add_item_info_modal:function(e){var t,a=r.Node.create('<div class="metainfo"></div>'),i=[[M.str.mod_mediagallery.caption,e.caption],[M.str.mod_mediagallery.datecreated,e.timecreatedformatted],[M.str.moodle.fullnameuser,e.firstname+" "+e.lastname],[M.str.moodle.username,e.username],[M.str.moodle.group,e.groupname],[M.str.moodle.description,e.description],[M.str.mod_mediagallery.moralrights,"1"==e.moralrights?M.str.moodle.yes:M.str.moodle.no],[M.str.mod_mediagallery.copyright,e.copyrightformatted],[M.str.mod_mediagallery.originalauthor,e.originalauthor],[M.str.mod_mediagallery.productiondate,e.productiondateformatted],[M.str.mod_mediagallery.medium,e.medium],[M.str.mod_mediagallery.publisher,e.publisher],[M.str.mod_mediagallery.broadcaster,e.broadcaster],[M.str.mod_mediagallery.reference,e.reference],[M.str.mod_mediagallery.tags,e.tags]];r.each(i,function(e,t){var o=!0;(o=4!==t&&3!==t&&7!=t||null!==i[t][1]&&""!==i[t][1]?o:!1)&&r.Node.create('<div class="field">'+e[0]+'</div><div class="value">'+e[1]+"</div>").appendTo(a)}),t={headerContent:M.str.mod_mediagallery.information,bodyContent:a,modal:!0},r.one(
".item[data-id="+e.id+"] .action-icon.info").on("click",function(e){e.preventDefault(),new M.core.dialogue(t).show()})},delete_object:function(i,l){i.m=this.mid,i.sesskey=M.cfg.sesskey,r.io(M.mod_mediagallery.base.uri,{method:"DELETE",data:i,on:{success:function(e,t){try{var o=r.JSON.parse(t.responseText);o.error&&new M.core.ajaxException(o)}catch(a){new M.core.ajaxException}l&&r.one(l+"[data-id="+i.id+"]").remove(),o.actinfohtml&&r.one(".activity-information")&&r.one(".activity-information").replace(o.actinfohtml),"collection"===i["class"]&&(window.location.href=M.cfg.wwwroot+"/course/view.php?id="+this.courseid)},failure:function(){0}},context:this,sync:!0})},lbg_setup:function(){var e,t;this.lbg_setup_ran||(this.lbg_setup_ran=!0,e=r.one(".lb-social"),t='<div class="lb-extradetails"></div><div class="lb-socialactions">',this.options.enablelikes&&(t=(t+='<a class="like" href="#"><div class="like"></div>')+M.str.mod_mediagallery.like+'</a><span id="lb-likedby"></span>'),e.setHTML(t+='<span id="lb-fullsize"></span></div><div id="lb-comments"></div>'),r.delegate("click",function(e){var o,t,a,i;e.preventDefault(),e="like",o=1,t="unlike",a='<div class="unlike"></div>',r.one(".lb-socialactions a.like div").hasClass("unlike")&&(e="unlike",o=0,t="like",a='<div class="like"></div>'),i=r.one(".lb-data"),i={sesskey:M.cfg.sesskey,m:M.mod_mediagallery.base.mid,id:i.getData("itemid"),"class":"item",action:e},r.io(M.mod_mediagallery.base.uri,{method:"POST",data:i,on:{success:function(e,t){t=JSON.parse(t.responseText);M.mod_mediagallery.base.update_likes(t.likes,o)}},context:this,sync:!0}),r.one(".lb-socialactions a.like").setHTML(a+M.str.mod_mediagallery[t])},".lb-social",".lb-socialactions a.like"))},update_likes:function(e,t){var o="";0<e&&(o="&nbsp;&bull;&nbsp;",o+=M.str.mod_mediagallery.likedby+": ",t&&(e-=1,o+=M.str.mod_mediagallery.you+", "),o=(o+=e+" ")+(1!=e?M.str.mod_mediagallery.others:M.str.mod_mediagallery.other)),r.one("#lb-likedby").setHTML(o)},lbg_change:function(a,e){var i;this.lbg_setup_ran||this.lbg_setup(),r.one(".lb-data").setData("itemid",a.itemid),"0"!==a.player&&"2"!==a.player||this.lbg_embed_player(a.itemid,e),i=r.one(".lb-data"),e={sesskey:M.cfg.sesskey,m:M.mod_mediagallery.base.mid,id:i.getData("itemid"),"class":"item",action:"socialinfo"},r.io(M.mod_mediagallery.base.uri,{method:"GET",data:e,on:{success:function(e,t){var o,t=JSON.parse(t.responseText);t.commentcontrol&&(r.one("#lb-comments").setHTML(t.commentcontrol),o={client_id:t.client_id,contextid:t.contextid,itemid:i.getData("itemid"),component:"mod_mediagallery",commentarea:"item"},M.core_comment.init(r,o)),this.options.enablelikes&&(o='<div class="like"></div>',t.likedbyme?(o='<div class="unlike"></div>',r.one(".lb-socialactions a.like").setHTML(o+M.str.mod_mediagallery.unlike)):r.one(".lb-socialactions a.like").setHTML(o+M.str.mod_mediagallery.like),M.mod_mediagallery.base.update_likes(t.likes,t.likedbyme)),o="","1"===a.player&&(this.options.enablelikes&&(o+="&nbsp;&bull;&nbsp;"),o=(o+='<a href="'+a.url+'?forcedownload=0" target="_blank">')+M.str.mod_mediagallery.viewfullsize+"</a>"),r.one("#lb-fullsize").setHTML(o),t.extradetails&&r.one(".lb-social .lb-extradetails").setHTML(t.extradetails)}},context:this,sync:!0})},lbg_embed_player:function(e,o){e={method:"GET",data:{sesskey:M.cfg.sesskey,m:M.mod_mediagallery.base.mid,"class":"item",action:"embed",id:e},on:{success:function(e,t){t=JSON.parse(t.responseText);r.one(".lb-image").ancestor().append(t.html),"audio"===t.type?M.util.add_audio_player(t.id,t.url,!1):M.util.add_video_player(t.id,t.url,!1),M.mod_mediagallery.base.load_flowplayer(),"video"===t.type&&o.sizeContainer(400,400)}},context:this,sync:!0};r.io(M.mod_mediagallery.base.uri,e)},load_flowplayer:function(){var e,t,o;0==M.util.video_players.length&&0==M.util.audio_players.length||(e=function(){for(var e,t,o,a,i,l,r={autoHide:!0},s=0;s<M.util.video_players.length;s++)t=0<(e=M.util.video_players[s]).width&&0<e.height?{src:M.cfg.wwwroot+"/lib/flowplayer/flowplayer-3.2.18.swf",width:e.width,height:e.height}:M.cfg.wwwroot+"/lib/flowplayer/flowplayer-3.2.18.swf",flowplayer(e.id,t,{plugins:{controls:r},clip:{url:e.fileurl,autoPlay:!1,autoBuffering:!0,scaling:"fit",mvideo:e,onMetaData:function(e){var t,o;e.mvideo.autosize&&!e.mvideo.resized&&(e.mvideo.resized=!0,o=t=0,o="undefined"==typeof e.metaData.width||"undefined"==typeof e.metaData.height?(t=e.width,e.height):(t=e.metaData.width,e.metaData.height),t<300&&(o=300*o/t,t=300),(e=this._api()).width=t,e.height=o)}}});if(M.util.video_players=[],0!=M.util.audio_players.length){for(r={autoHide:!1,fullscreen:!1,next:!1,previous:!1,scrubber:!0,play:!0,pause:!0,volume:!0,mute:!1,backgroundGradient:[.5,0,.3]},a=0;a<document.styleSheets.length;a++){i=!1;try{if("undefined"!=typeof document.styleSheets[a].rules)i=document.styleSheets[a].rules;else{if("undefined"==typeof document.styleSheets[a].cssRules)continue;i=document.styleSheets[a].cssRules}}catch(n){continue}if(i){for(s=0;s<i.length;s++)o="",/^\.mp3flowplayer_.*Color$/.test(i[s].selectorText)&&("undefined"!=typeof i[s].cssText?o=i[s].cssText:"undefined"!=typeof i[s].style.cssText&&(o=i[s].style.cssText),""!=o&&/.*color\s*:\s*([^;]+).*/gi.test(o)&&(o=o.replace(/.*color\s*:\s*([^;]+).*/gi,"$1"),r[i[s].selectorText.replace(/^\.mp3flowplayer_/,"")]=o));i=!1}}for(s=0;s<M.util.audio_players.length;s++)(l=M.util.audio_players[s]).small?(r.controlall=!1,r.height=15,r.time=!1):(r.controlall=!0,r.height=25,r.time=!0),flowplayer(l.id,M.cfg.wwwroot+"/lib/flowplayer/flowplayer-3.2.18.swf",{plugins:{controls:r,audio:{url:M.cfg.wwwroot+"/lib/flowplayer/flowplayer.audio-3.2.11.swf"}},clip:{url:l.fileurl,provider:"audio",autoPlay:!1}});M.util.audio_players=[]}},"undefined"==typeof flowplayer?(t=-1==M.cfg.jsrev?M.cfg.wwwroot+"/lib/flowplayer/flowplayer-3.2.13.js":M.cfg.wwwroot+"/lib/javascript.php?jsfile=/lib/flowplayer/flowplayer-3.2.13.min.js&rev="+M.cfg.jsrev,(o=document.createElement("script")).setAttribute("type","text/javascript"),
o.setAttribute("src",t),o.onload=e,o.onreadystatechange=e,document.getElementsByTagName("head")[0].appendChild(o)):e())},setup_sample_link:function(){var t={title:M.str.mod_mediagallery.addsamplegallery,question:'<img src="'+M.util.image_url("i/loading_small")+'" title="Processing..." />',yesLabel:M.str.moodle.add,noLabel:M.str.moodle.cancel,closeButtonTitle:M.str.moodle.cancel};r.one("#mg_sample")&&r.one("#mg_sample").on("click",function(i){var l,e;i.preventDefault(),l=new M.core.confirm(t),e={method:"GET",data:{sesskey:M.cfg.sesskey,m:M.mod_mediagallery.base.mid,"class":"gallery",id:M.mod_mediagallery.base.gallery,action:"get_sample_targets"},on:{success:function(e,t){var o,a;try{(o=r.JSON.parse(t.responseText)).error&&new M.core.ajaxException(o)}catch(i){new M.core.ajaxException}t=r.Node.create('<div class="sample_target_wrapper"><span>'+M.str.mod_mediagallery.mediagallery+":</span></div>"),a=r.Node.create('<select id="sample_target"/>'),t.append(a),r.Object.each(o,function(e,t){r.Node.create('<option value="'+t+'">'+e+"</option>").appendTo(a)}),l.bodyNode.one(".confirmation-message").setHTML(t)},failure:function(e,t){}},context:this,sync:!0},r.io(M.mod_mediagallery.base.uri,e),l.on("complete-yes",function(){var e=r.one("#sample_target").get("value"),e={method:"POST",data:{sesskey:M.cfg.sesskey,m:M.mod_mediagallery.base.mid,"class":"gallery",id:M.mod_mediagallery.base.gallery,action:"sample","data[]":e},on:{success:function(e,t){try{var o=r.JSON.parse(t.responseText);o.error&&new M.core.ajaxException(o)}catch(i){new M.core.ajaxException}o.actinfohtml&&r.one(".activity-information")&&r.one(".activity-information").replace(o.actinfohtml)},failure:function(){}},context:this,sync:!0};r.io(M.mod_mediagallery.base.uri,e)},this),l.show()})},watch_resize:function(){var t=r.one(".gallery_items.editing");t&&t.on("windowresize",function(){var e=t.get("offsetWidth"),o=Math.floor(e/M.mod_mediagallery.base.defaultitemwidth),a=r.Node.create('<div class="rowdivider clearfix"></div>');t.all(".rowdivider").remove(),t.all(".item").each(function(e,t){t%o==0&&e.insert(a,"before")})})}},M.mod_mediagallery=M.mod_mediagallery||{},M.mod_mediagallery.dragdrop={CSS:{CONTAINER:".gallery_items",ITEMS:".gallery_items .item",CONTROLCONTAINER:".controls",HANDLE:".controls :first-child",HANDLELINK:".controls .move"},init:function(){var a="i/move_2d",i="moodle",l=!1,o=0,e=r.Node.all(this.CSS.ITEMS);e.each(function(e){var t=M.mod_mediagallery.dragdrop.CSS,o=r.Node.create('<img class="smallicon move action-icon" title="'+M.str.moodle.move+'"/>');o.setAttribute("src",M.util.image_url(a,i)),o.addClass("cursor"),e.one(t.CONTROLCONTAINER).prepend(o),new r.DD.Drag({node:e,target:{padding:"0 0 0 20"}}).plug(r.Plugin.DDProxy,{moveOnEnd:!1}).plug(r.Plugin.DDConstrained,{constrain2node:t.CONTAINER}).addHandle(t.HANDLE)}),r.DD.DDM.on("drag:start",function(e){e.preventDefault();e=e.target;e.get("node").setStyle("opacity",".25"),e.get("dragNode").addClass("mod_mediagallery item"),e.get("dragNode").set("innerHTML",e.get("node").get("innerHTML")),e.get("dragNode").setStyles({opacity:".5",borderColor:e.get("node").getStyle("borderColor"),backgroundColor:e.get("node").getStyle("backgroundColor")})}),r.DD.DDM.on("drag:end",function(e){e.target.get("node").setStyles({visibility:"",opacity:"1"}),M.mod_mediagallery.dragdrop.save()}),r.DD.DDM.on("drag:drag",function(e){var t=e.target.lastXY[0],e=e.target.lastXY[1];l=t<o,o=t,0}),r.DD.DDM.on("drop:over",function(e){var t=e.drag.get("node"),o=e.drop.get("node"),a=r.all(M.mod_mediagallery.dragdrop.CSS.ITEMS);l=a.indexOf(o)<a.indexOf(t),o.hasClass("item")&&(l||(o=o.get("nextSibling")),e.drop.get("node").get("parentNode").insertBefore(t,o),e.drop.sizeShim())}),r.DD.DDM.on("drag:drophit",function(e){var t=e.drop.get("node"),e=e.drag.get("node");t.hasClass("item")||t.contains(e)||t.appendChild(e)})},save:function(){var e=r.one(this.CSS.CONTAINER).get("children").getData("id"),e={sesskey:M.cfg.sesskey,data:e,"class":"gallery",m:M.mod_mediagallery.base.mid,id:M.mod_mediagallery.base.gallery,action:"sortorder"};r.io(M.cfg.wwwroot+"/mod/mediagallery/rest.php",{method:"POST",data:build_querystring(e),context:this})}}},"@VERSION@",{requires:["base","node","selector-css3","dd-constrain","dd-proxy","dd-drop","dd-plugin","moodle-core-notification","event"]});