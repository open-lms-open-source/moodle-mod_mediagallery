YUI.add("moodle-mod_mediagallery-base",function(e,t){M.mod_mediagallery=M.mod_mediagallery||{},M.mod_mediagallery.base={defaultitemwidth:187,courseid:0,mid:0,gallery:0,lbg_setup_ran:!1,options:{enablecomments:!1,enablelikes:!1,mode:"standard"},uri:M.cfg.wwwroot+"/mod/mediagallery/rest.php",init:function(e,t,n,r,i,s){this.courseid=e,this.mid=t,this.gallery=i,s&&s.enablecomments&&(this.options.enablecomments=!0),s&&s.enablelikes&&(this.options.enablelikes=!0),s&&s.mode&&(this.options.mode=s.mode);if(r||n==="gallery")this.options.mode!=="thebox"?this.watch_editing_buttons(n):this.watch_delete_thebox(n);i===0&&n==="gallery"&&this.add_remove_collection_handler(),r||this.watch_mediasize(),this.setup_sample_link(),this.watch_resize()},add_remove_collection_handler:function(){var t=e.one(".collection.actions .remove");if(!t)return;var n=t.hasClass("owner"),r={title:M.str.mod_mediagallery.confirmcollectiondelete,question:M.str.mod_mediagallery.removecollectionconfirm,yesLabel:M.str.moodle.submit,noLabel:M.str.moodle.cancel,closeButtonTitle:M.str.moodle.cancel},i={"class":"collection",id:this.mid};this._confirmationListener=this._confirmationListener||t.on("click",function(t){t.preventDefault();var s;if(!n)s=new M.core.confirm(r),i.action="remove",s.on("complete-yes",function(){this._confirmationListener.detach(),M.mod_mediagallery.base.delete_object(i)},this);else{var o=M.str.mod_mediagallery.deleteorremovecollection;o+='<br/><input type="textbox" name="deleteorremove"/><br/>',o+=M.str.mod_mediagallery.deleteorremovecollectionwarn,r.question='<div class="deleteorremove">'+o+"</div>",s=new M.core.confirm(r),s.on("complete-yes",function(){i.action="remove";var t=e.one('input[name="deleteorremove"]');if(t)if(t.get("value").toUpperCase()==="DELETE")i.action="delete";else if(t.get("value")!=="")return;this._confirmationListener.detach(),M.mod_mediagallery.base.delete_object(i)},this)}s.show()},this)},watch_delete_thebox:function(t){var n=".gallery_list_item";t==="item"&&(n=".item");var r={title:M.str.mod_mediagallery["confirm"+t+"delete"],yesLabel:M.str.moodle.submit,noLabel:M.str.moodle.cancel,closeButtonTitle:M.str.moodle.cancel};e.all(n+" .controls .delete").each(function(){this._confirmationListener=this._confirmationListener||this.on("click",function(i){i.preventDefault();var s=this.hasClass("owner"),o=this.ancestor("div"+n).getData();o.class=t;var u;if(!s)r.question=M.str.mod_mediagallery["remove"+t+"confirm"],u=new M.core.confirm(r),o.action="remove",u.on("complete-yes",function(){this._confirmationListener.detach(),M.mod_mediagallery.base.delete_object(o,n)},this);else{var a=M.str.mod_mediagallery["deleteorremove"+t];a+='<br/><input type="textbox" name="deleteorremove"/><br/>',a+=M.str.mod_mediagallery["deleteorremove"+t+"warn"],r.question='<div class="deleteorremove">'+a+"</div>",u=new M.core.confirm(r),u.on("complete-yes",function(){o.action="remove";var t=e.one('input[name="deleteorremove"]');if(t)if(t.get("value").toUpperCase()==="DELETE")o.action="delete";else if(t.get("value")!=="")return;this._confirmationListener.detach(),M.mod_mediagallery.base.delete_object(o,n)},this)}u.show()},this)})},watch_editing_buttons:function(t){var n=".gallery_list_item";t==="item"&&(n=".item");var r={title:M.str.mod_mediagallery["confirm"+t+"delete"],origquestion:M.str.mod_mediagallery["delete"+t]+" ",yesLabel:M.str.moodle.yes,noLabel:M.str.moodle.cancel,closeButtonTitle:M.str.moodle.cancel};e.all(n+" .controls .delete").each(function(){this._confirmationListener=this._confirmationListener||this.on("click",function(e){e.preventDefault();var i=this.ancestor("div"+n).getData();r.question=r.origquestion+i.title+"?";var s=new M.core.confirm(r);s.on("complete-yes",function(){this._confirmationListener.detach(),i["class"]=t,M.mod_mediagallery.base.delete_object(i,n)},this),s.show()},this)})},watch_mediasize:function(){var t=".mediasize_selector select",n=".gallery";if(!e.one(t))return;e.one(t).on("change",function(t){t.preventDefault();var r=e.one(n);r.removeClass("small"),r.removeClass("large");var i=t.target.get("value"),s="";i==="0"?s="small":i==="2"&&(s="large"),s!==""&&r.addClass(s),M.util.set_user_preference("mod_mediagallery_mediasize",i)})},add_gallery_info_modal:function(t,n){var r=e.Node.create('<div class="metainfo"></div>'),i='<a href="'+M.cfg.wwwroot+"/user/view.php?id="+n.userid;i+="&course="+t+'">'+n.firstname+" "+n.lastname+"</a>";var s=[[M.str.mod_mediagallery.galleryname,n.name],[M.str.mod_mediagallery.creator,i]];n.groupname!==null&&s.push([M.str.moodle.group,n.groupname]),e.each(s,function(t){e.Node.create('<div class="field">'+t[0]+'</div><div class="value">'+t[1]+"</div>").appendTo(r)});var o={headerContent:M.str.mod_mediagallery.information,bodyContent:r,modal:!0};e.one(".gallery_list_item[data-id="+n.id+"] .action-icon.info").on("click",function(e){e.preventDefault();var t=new M.core.dialogue(o);t.show()})},add_item_info_modal:function(t){var n=e.Node.create('<div class="metainfo"></div>'),r=[[M.str.mod_mediagallery.caption,t.caption],[M.str.mod_mediagallery.datecreated,t.timecreatedformatted],[M.str.moodle.fullnameuser,t.firstname+" "+t.lastname],[M.str.moodle.username,t.username],[M.str.moodle.group,t.groupname],[M.str.moodle.description,t.description],[M.str.mod_mediagallery.moralrights,t.moralrights=="1"?M.str.moodle.yes:M.str.moodle.no],[M.str.mod_mediagallery.copyright,t.copyrightformatted],[M.str.mod_mediagallery.originalauthor,t.originalauthor],[M.str.mod_mediagallery.productiondate,t.productiondateformatted],[M.str.mod_mediagallery.medium,t.medium],[M.str.mod_mediagallery.publisher,t.publisher],[M.str.mod_mediagallery.broadcaster,t.broadcaster],[M.str.mod_mediagallery.reference,t.reference],[M.str.mod_mediagallery.tags,t.tags]];e.each(r,function(t,i){var s=!0;(i===4||i===3||i==7)&&(r[i][1]===null||r[i][1]==="")&&(s=!1),s&&e.Node.create('<div class="field">'+t[0]+'</div><div class="value">'+t[1]+"</div>").appendTo(n)});var i={headerContent:M.str.mod_mediagallery.information,bodyContent
:n,modal:!0};e.one(".item[data-id="+t.id+"] .action-icon.info").on("click",function(e){e.preventDefault();var t=new M.core.dialogue(i);t.show()})},delete_object:function(t,n){var r=!1;t.m=this.mid,t.sesskey=M.cfg.sesskey;var i={method:"DELETE",data:t,on:{success:function(i,s){try{var o=e.JSON.parse(s.responseText);o.error&&new M.core.ajaxException(o)}catch(u){new M.core.ajaxException}r&&window.setTimeout(function(){r.hide()},400),n&&e.one(n+"[data-id="+t.id+"]").remove(),t["class"]==="collection"&&(window.location.href=M.cfg.wwwroot+"/course/view.php?id="+this.courseid)},failure:function(){r&&r.hide()}},context:this,sync:!0};r&&r.show(),e.io(M.mod_mediagallery.base.uri,i)},lbg_setup:function(){if(this.lbg_setup_ran)return;this.lbg_setup_ran=!0;var t=e.one(".lb-social"),n='<div class="lb-extradetails"></div><div class="lb-socialactions">';this.options.enablelikes&&(n+='<a class="like" href="#"><div class="like"></div>',n+=M.str.mod_mediagallery.like+'</a><span id="lb-likedby"></span>'),n+='<span id="lb-fullsize"></span></div><div id="lb-comments"></div>',t.setHTML(n),e.delegate("click",function(t){t.preventDefault();var n="like",r=1,i="unlike",s='<div class="unlike"></div>';e.one(".lb-socialactions a.like div").hasClass("unlike")&&(n="unlike",r=0,i="like",s='<div class="like"></div>');var o=e.one(".lb-data"),u={sesskey:M.cfg.sesskey,m:M.mod_mediagallery.base.mid,id:o.getData("itemid"),"class":"item",action:n},a={method:"POST",data:u,on:{success:function(e,t){var n=JSON.parse(t.responseText);M.mod_mediagallery.base.update_likes(n.likes,r)}},context:this,sync:!0};e.io(M.mod_mediagallery.base.uri,a),e.one(".lb-socialactions a.like").setHTML(s+M.str.mod_mediagallery[i])},".lb-social",".lb-socialactions a.like")},update_likes:function(t,n){var r="";t>0&&(r="&nbsp;&bull;&nbsp;",r+=M.str.mod_mediagallery.likedby+": ",n&&(t-=1,r+=M.str.mod_mediagallery.you+", "),r+=t+" ",t!=1?r+=M.str.mod_mediagallery.others:r+=M.str.mod_mediagallery.other),e.one("#lb-likedby").setHTML(r)},lbg_change:function(t,n){this.lbg_setup_ran||this.lbg_setup();var r=e.one(".lb-data");r.setData("itemid",t.itemid),(t.player==="0"||t.player==="2")&&this.lbg_embed_player(t.itemid,n);var i=e.one(".lb-data"),s={sesskey:M.cfg.sesskey,m:M.mod_mediagallery.base.mid,id:i.getData("itemid"),"class":"item",action:"socialinfo"},o={method:"GET",data:s,on:{success:function(n,r){var s=JSON.parse(r.responseText);if(s.commentcontrol){e.one("#lb-comments").setHTML(s.commentcontrol);var o={client_id:s.client_id,contextid:s.contextid,itemid:i.getData("itemid"),component:"mod_mediagallery",commentarea:"item"};M.core_comment.init(e,o)}if(this.options.enablelikes){var u='<div class="like"></div>';s.likedbyme?(u='<div class="unlike"></div>',e.one(".lb-socialactions a.like").setHTML(u+M.str.mod_mediagallery.unlike)):e.one(".lb-socialactions a.like").setHTML(u+M.str.mod_mediagallery.like),M.mod_mediagallery.base.update_likes(s.likes,s.likedbyme)}var a="";t.player==="1"&&(this.options.enablelikes&&(a+="&nbsp;&bull;&nbsp;"),a+='<a href="'+t.url+'?forcedownload=0" target="_blank">',a+=M.str.mod_mediagallery.viewfullsize+"</a>"),e.one("#lb-fullsize").setHTML(a);if(s.extradetails){var f=e.one(".lb-social .lb-extradetails");f.setHTML(s.extradetails)}}},context:this,sync:!0};e.io(M.mod_mediagallery.base.uri,o)},lbg_embed_player:function(t,n){var r={method:"GET",data:{sesskey:M.cfg.sesskey,m:M.mod_mediagallery.base.mid,"class":"item",action:"embed",id:t},on:{success:function(t,r){var i=JSON.parse(r.responseText);e.one(".lb-image").ancestor().append(i.html),i.type==="audio"?M.util.add_audio_player(i.id,i.url,!1):M.util.add_video_player(i.id,i.url,!1),M.mod_mediagallery.base.load_flowplayer(),i.type==="video"&&n.sizeContainer(400,400)}},context:this,sync:!0};e.io(M.mod_mediagallery.base.uri,r)},load_flowplayer:function(){if(M.util.video_players.length==0&&M.util.audio_players.length==0)return;var e=function(){var e={autoHide:!0};for(var t=0;t<M.util.video_players.length;t++){var n=M.util.video_players[t];if(n.width>0&&n.height>0)var r={src:M.cfg.wwwroot+"/lib/flowplayer/flowplayer-3.2.18.swf",width:n.width,height:n.height};else var r=M.cfg.wwwroot+"/lib/flowplayer/flowplayer-3.2.18.swf";flowplayer(n.id,r,{plugins:{controls:e},clip:{url:n.fileurl,autoPlay:!1,autoBuffering:!0,scaling:"fit",mvideo:n,onMetaData:function(e){if(e.mvideo.autosize&&!e.mvideo.resized){e.mvideo.resized=!0;var t=0,n=0;typeof e.metaData.width=="undefined"||typeof e.metaData.height=="undefined"?(t=e.width,n=e.height):(t=e.metaData.width,n=e.metaData.height);var r=300;t<r&&(n=n*r/t,t=r);var i=this._api();i.width=t,i.height=n}}}})}M.util.video_players=[];if(M.util.audio_players.length==0)return;var e={autoHide:!1,fullscreen:!1,next:!1,previous:!1,scrubber:!0,play:!0,pause:!0,volume:!0,mute:!1,backgroundGradient:[.5,0,.3]},i;for(var s=0;s<document.styleSheets.length;s++){var o=!1;try{if(typeof document.styleSheets[s].rules!="undefined")o=document.styleSheets[s].rules;else{if(typeof document.styleSheets[s].cssRules=="undefined")continue;o=document.styleSheets[s].cssRules}}catch(u){continue}if(!o)continue;for(var t=0;t<o.length;t++){i="";if(/^\.mp3flowplayer_.*Color$/.test(o[t].selectorText)){typeof o[t].cssText!="undefined"?i=o[t].cssText:typeof o[t].style.cssText!="undefined"&&(i=o[t].style.cssText);if(i!=""&&/.*color\s*:\s*([^;]+).*/gi.test(i)){i=i.replace(/.*color\s*:\s*([^;]+).*/gi,"$1");var a=o[t].selectorText.replace(/^\.mp3flowplayer_/,"");e[a]=i}}}o=!1}for(var t=0;t<M.util.audio_players.length;t++){var f=M.util.audio_players[t];f.small?(e.controlall=!1,e.height=15,e.time=!1):(e.controlall=!0,e.height=25,e.time=!0),flowplayer(f.id,M.cfg.wwwroot+"/lib/flowplayer/flowplayer-3.2.18.swf",{plugins:{controls:e,audio:{url:M.cfg.wwwroot+"/lib/flowplayer/flowplayer.audio-3.2.11.swf"}},clip:{url:f.fileurl,provider:"audio",autoPlay:!1}})}M.util.audio_players=[]};if(typeof flowplayer=="undefined"){if(M.cfg.jsrev==-1)var t=M.cfg.wwwroot+"/lib/flowplayer/flowplayer-3.2.13.js";else var t=M.cfg.wwwroot+"/lib/javascript.php?jsfile=/lib/flowplayer/flowplayer-3.2.13.min.js&rev="+
M.cfg.jsrev;var n=document.createElement("script");n.setAttribute("type","text/javascript"),n.setAttribute("src",t),n.onload=e,n.onreadystatechange=e,document.getElementsByTagName("head")[0].appendChild(n)}else e()},setup_sample_link:function(){var t={title:M.str.mod_mediagallery.addsamplegallery,question:'<img src="'+M.util.image_url("i/loading_small")+'" title="Processing..." />',yesLabel:M.str.moodle.add,noLabel:M.str.moodle.cancel,closeButtonTitle:M.str.moodle.cancel};e.one("#mg_sample")&&e.one("#mg_sample").on("click",function(n){n.preventDefault();var r=new M.core.confirm(t),i={method:"GET",data:{sesskey:M.cfg.sesskey,m:M.mod_mediagallery.base.mid,"class":"gallery",id:M.mod_mediagallery.base.gallery,action:"get_sample_targets"},on:{success:function(t,n){try{var i=e.JSON.parse(n.responseText);i.error&&new M.core.ajaxException(i)}catch(s){new M.core.ajaxException}var o=e.Node.create('<div class="sample_target_wrapper"><span>'+M.str.mod_mediagallery.mediagallery+":</span></div>"),u=e.Node.create('<select id="sample_target"/>');o.append(u),e.Object.each(i,function(t,n){e.Node.create('<option value="'+n+'">'+t+"</option>").appendTo(u)}),r.bodyNode.one(".confirmation-message").setHTML(o)},failure:function(e,t){}},context:this,sync:!0};e.io(M.mod_mediagallery.base.uri,i),r.on("complete-yes",function(){var t=e.one("#sample_target").get("value"),n={method:"POST",data:{sesskey:M.cfg.sesskey,m:M.mod_mediagallery.base.mid,"class":"gallery",id:M.mod_mediagallery.base.gallery,action:"sample","data[]":t},on:{success:function(t,n){try{var r=e.JSON.parse(n.responseText);r.error&&new M.core.ajaxException(r)}catch(i){new M.core.ajaxException}},failure:function(){}},context:this,sync:!0};e.io(M.mod_mediagallery.base.uri,n)},this),r.show()})},watch_resize:function(){var t=e.one(".gallery_items.editing");if(!t)return;t.on("windowresize",function(){var n=t.get("offsetWidth"),r=Math.floor(n/M.mod_mediagallery.base.defaultitemwidth),i=e.Node.create('<div class="rowdivider clearfix"></div>');t.all(".rowdivider").remove(),t.all(".item").each(function(e,t){t%r===0&&e.insert(i,"before")})})}},M.mod_mediagallery=M.mod_mediagallery||{},M.mod_mediagallery.dragdrop={CSS:{CONTAINER:".gallery_items",ITEMS:".gallery_items .item",CONTROLCONTAINER:".controls",HANDLE:".controls :first-child",HANDLELINK:".controls .move"},init:function(){var t={pix:"i/move_2d",component:"moodle"},n=!1,r=0,i=0,s=e.Node.all(this.CSS.ITEMS);s.each(function(n){var r=M.mod_mediagallery.dragdrop.CSS,i=e.Node.create('<img class="smallicon move action-icon" title="'+M.str.moodle.move+'"/>');i.setAttribute("src",M.util.image_url(t.pix,t.component)),i.addClass("cursor"),n.one(r.CONTROLCONTAINER).prepend(i);var s=(new e.DD.Drag({node:n,target:{padding:"0 0 0 20"}})).plug(e.Plugin.DDProxy,{moveOnEnd:!1}).plug(e.Plugin.DDConstrained,{constrain2node:r.CONTAINER});s.addHandle(r.HANDLE)}),e.DD.DDM.on("drag:start",function(e){e.preventDefault();var t=e.target;t.get("node").setStyle("opacity",".25"),t.get("dragNode").addClass("mod_mediagallery item"),t.get("dragNode").set("innerHTML",t.get("node").get("innerHTML")),t.get("dragNode").setStyles({opacity:".5",borderColor:t.get("node").getStyle("borderColor"),backgroundColor:t.get("node").getStyle("backgroundColor")})}),e.DD.DDM.on("drag:end",function(e){var t=e.target;t.get("node").setStyles({visibility:"",opacity:"1"}),M.mod_mediagallery.dragdrop.save()}),e.DD.DDM.on("drag:drag",function(e){var t=e.target.lastXY[0],s=e.target.lastXY[1];t<r?n=!0:n=!1,r=t,i=s}),e.DD.DDM.on("drop:over",function(t){var r=t.drag.get("node"),i=t.drop.get("node"),s=e.all(M.mod_mediagallery.dragdrop.CSS.ITEMS);s.indexOf(i)<s.indexOf(r)?n=!0:n=!1,i.hasClass("item")&&(n||(i=i.get("nextSibling")),t.drop.get("node").get("parentNode").insertBefore(r,i),t.drop.sizeShim())}),e.DD.DDM.on("drag:drophit",function(e){var t=e.drop.get("node"),n=e.drag.get("node");t.hasClass("item")||t.contains(n)||t.appendChild(n)})},save:function(){var t=e.one(this.CSS.CONTAINER).get("children").getData("id"),n={sesskey:M.cfg.sesskey,data:t,"class":"gallery",m:M.mod_mediagallery.base.mid,id:M.mod_mediagallery.base.gallery,action:"sortorder"};e.io(M.cfg.wwwroot+"/mod/mediagallery/rest.php",{method:"POST",data:build_querystring(n),context:this})}}},"@VERSION@",{requires:["base","node","selector-css3","dd-constrain","dd-proxy","dd-drop","dd-plugin","moodle-core-notification","event"]});
