YUI.add("moodle-mod_mediagallery-mediabox",function(g,e){var t=function(){t.superclass.constructor.apply(this,arguments)};g.extend(t,g.Base,{initializer:function(){this.enable(),this.build(),this._sidebarwidth=300,this._navbarheight=60,this.currentitem=null,this._audiowidth=250,this._audioheight=275,this._videowidth=640,this._videoheight=390,this._fullscreenavail=screenfull.enabled&&!g.one("body").hasClass("ui-mobile-viewport"),this._loadingimage=g.Node.create("<img/>").setAttribute("src",M.util.image_url("loading","mod_mediagallery"))},build:function(){var e,t,i,o=this,a=M.str.moodle.next,n=M.str.moodle.previous,d=M.util.get_string("download","mod_mediagallery"),l=M.util.get_string("thisdirection","core_langconfig"),r=M.str.mod_mediagallery.togglesidebar,m=M.str.mod_mediagallery.togglefullscreen,c=M.str.mod_mediagallery.close,s='<img class="sidebartoggle" src="';for(s+=M.util.image_url("toggle","mod_mediagallery")+'" title="'+r+'" alt="'+r+'"/>',s="ltr"===l?(s=(s+='<img class="prev" src="')+M.util.image_url("left","mod_mediagallery")+'" title="'+a+'" alt="'+a+'"/><img class="next" src="')+M.util.image_url("right","mod_mediagallery")+'" title="'+n+'" alt="'+n+'"/>':(s=(s+='<img class="prev" src="')+M.util.image_url("right","mod_mediagallery")+'" title="'+a+'" alt="'+a+'"/><img class="next" src="')+M.util.image_url("left","mod_mediagallery")+'" title="'+n+'" alt="'+n+'"/>',s=(s+='<img class="open" src="')+(M.util.image_url("download","mod_mediagallery")+'" title="'+d+'" alt="'+d+'"/>'),this._fullscreenavail&&(s=s+('<img class="fullscreen" src="'+M.util.image_url("fullscreen","mod_mediagallery"))+'" title="'+m+'" alt="'+m+'"/>'),s=(s+='<img class="mbclose" src="')+(M.util.image_url("close","mod_mediagallery")+'" title="'+c+'" alt="'+c+'"/>'),r='<div id="mediabox"><div id="mediabox-content-wrap"><div id="mediabox-content"></div></div>',g.Node.create((r+='<div id="mediabox-sidebar">')+'<div id="mediabox-metainfo"></div><hr/>'+'<div id="mediabox-social"></div><hr/><div id="mediabox-comments"></div>'+"</div>"+('<div id="mediabox-sidebar-actions">'+s+"</div>")+'<div id="mediabox-navbar"><div id="mediabox-navbar-container"></div></div></div>'+'<div id="mediabox-overlay"></div>').appendTo("body"),this.overlay=g.one("#mediabox-overlay"),this.mediabox=g.one("#mediabox"),this.navbar=g.one("#mediabox-navbar"),this.resizeoverlay(),this.album=g.all("a[rel^=mediabox], area[rel^=mediabox], a[data-mediabox], area[data-mediabox]").getDOMNodes(),this.overlay.on("click",function(){o.stop()}),g.delegate("click",function(e){if("mediabox-navbar-container"===e.currentTarget.get("id"))return!1;o.stop()},"#mediabox","#mediabox-navbar, #mediabox-navbar-container"),g.one("#mediabox-sidebar-actions .sidebartoggle").on("click",function(){o.mediabox.toggleClass("sidebarhidden"),o.resizeoverlay(),o.repositionitem()}),e=0;e<this.album.length;e++)(t=g.Node.create('<div class="navitem"></div>')).setAttribute("data-id",e),(i=g.Node.create("<img/>")).setAttribute("src",this.album[e].children[0].getAttribute("src")),i.appendTo(t),t.appendTo("#mediabox-navbar-container");g.delegate("click",function(e){e.preventDefault(),o.changeitem(e.currentTarget.getAttribute("data-id"))},"#mediabox-navbar",".navitem"),this.get("enablelikes")&&(l='<a class="like" href="#"><div class="like"></div>',l+=M.str.mod_mediagallery.like+'</a><span id="mediabox-likedby"></span>',g.Node.create(l).appendTo("#mediabox-social")),g.delegate("click",function(e){var i,t,a,n;e.preventDefault(),e="like",i=1,t="unlike",a='<div class="unlike"></div>',g.one("#mediabox-social a.like div").hasClass("unlike")&&(e="unlike",i=0,t="like",a='<div class="like"></div>'),(n=o.get("metainfodata")).id=o.album[o.currentitemindex].getAttribute(o.get("dataidfield")),n.action=e,e={method:"POST",data:n,on:{success:function(e,t){t=JSON.parse(t.responseText);o.update_likes(t.likes,i)}},context:this,sync:!0},g.io(o.get("metainfouri"),e),g.one("#mediabox-social a.like").setHTML(a+M.str.mod_mediagallery[t])},"#mediabox","#mediabox-social a.like"),g.delegate("blur",function(){o.enablenav()},"#mediabox","#mediabox-comments textarea"),g.delegate("focus",function(){o.disablenav()},"#mediabox","#mediabox-comments textarea"),g.one("#mediabox-sidebar-actions .prev").on("click",function(){return 0===o.currentitemindex?o.changeitem(o.album.length-1):o.changeitem(o.currentitemindex-1),!1}),g.one("#mediabox-sidebar-actions .next").on("click",function(){return o.currentitemindex===o.album.length-1?o.changeitem(0):o.changeitem(o.currentitemindex+1),!1}),g.one("#mediabox-sidebar-actions .open").on("click",function(){return window.open(o.album[o.currentitemindex].getAttribute("data-url")+"?forcedownload=1","_blank"),!1}),g.one("#mediabox-sidebar-actions .mbclose").on("click",function(){return o.stop(),!1}),this._fullscreenavail&&g.one("#mediabox-sidebar-actions .fullscreen").on("click",function(){return screenfull.toggle(o.mediabox.getDOMNode()),o.setfullscreenimg(),!1}),this.setup_info_toggle()},updatenavbarselection:function(e){var t,i=this.navbar.one(".navitem.current");i&&i.removeClass("current"),this.navbar.one('.navitem[data-id="'+e+'"]').addClass("current"),i=g.one("#mediabox-navbar"),t=(e=g.one("#mediabox-navbar-container .current")).get("clientWidth")+2*parseInt(e.getStyle("margin-left"),10),e=g.all("#mediabox-navbar-container .navitem").indexOf(e),i=i.get("clientWidth")/2-t/2-e*t,g.one("#mediabox-navbar-container").setStyle("margin-left",i+"px")},changeitem:function(o){var d,t,e,i,l,a,n;this.currentitemindex!==o&&(d=this,t=g.one("#mediabox-content"),e=this.album[o].getAttribute("data-player"),a=this.album[o].getAttribute("data-type"),t.empty(),this.updatenavbarselection(o),i=new Image,"2"!==e&&"youtube"!==a&&(t.prepend(this._loadingimage),d.repositionitem(i.width,i.height),i.onload=function(){var e=g.Node.create("<img/>");e.setAttribute("src",d.album[o].getAttribute("href")),t.all("img").remove(),t.prepend(e),d.repositionitem(i.width,i.height)},i.src=this.album[o].getAttribute("href")),
this.currentitemindex=parseInt(o,10),this.currentitem=this.album[o],(l=g.one("#mediabox-metainfo")).empty(),(a=this.get("metainfodata")).id=this.currentitem.getAttribute(this.get("dataidfield")),a.action="metainfo",n={method:"GET",data:a,on:{success:function(e,t){var i,a;try{i=JSON.parse(t.responseText)}catch(n){return}for(a=0;a<i.fields.length;a++)""!==i.fields[a].value&&g.Node.create('<div class="metafield '+i.fields[a].name+'"></div>').append('<div class="metaname">'+i.fields[a].displayname+"</div>").append('<div class="metavalue">'+i.fields[a].value+"</div>").appendTo(l);i.commentcontrol&&(g.one("#mediabox-comments").setHTML(i.commentcontrol),t={client_id:i.client_id,contextid:i.contextid,itemid:this.album[o].getAttribute(this.get("dataidfield")),component:"mod_mediagallery",commentarea:"item",autostart:!0},M.core_comment!==undefined&&M.core_comment.init(g,t)),d.get("enablelikes")&&(t='<div class="like"></div>',i.likedbyme?(t='<div class="unlike"></div>',g.one("#mediabox-social a.like").setHTML(t+M.str.mod_mediagallery.unlike)):g.one("#mediabox-social a.like").setHTML(t+M.str.mod_mediagallery.like),this.update_likes(i.likes,i.likedbyme))}},context:this,sync:!0},""!==this.get("metainfouri")&&g.io(this.get("metainfouri"),n),"0"!==e&&"2"!==e||(this.embed_player(a.id),"0"===e?t.one(".mediaplugin").addClass("audio"):t.one(".mediaplugin").addClass("video")),"youtube"===this.currentitem.getAttribute("data-type")&&(t.empty(),n='<iframe id="mediabox-youtube" type="text/html" width="',n=(n+=this._videowidth+'" height="'+this._videoheight+'" src="')+this.currentitem.getAttribute("data-url")+'" frameborder="0">',g.Node.create(n).appendTo(t),this.repositionitem()))},disablenav:function(){this.keyboardnav.detach()},embed_player:function(e){var t=this.get("metainfodata");t.id=e,t.action="embed",e={method:"GET",data:t,on:{success:function(e,t){var t=JSON.parse(t.responseText);g.one("#mediabox-content").setHTML(t.html),"video"===t.type&&(t=g.one("#mediabox-content .mediaplugin"),this.repositionitem(t.get("offsetWidth"),t.get("offsetHeight")))}},context:this,sync:!0},g.io(this.get("metainfouri"),e)},enable:function(){var t=this;return g.one("body").all("a[rel^=mediabox], area[rel^=mediabox], a[data-mediabox], area[data-mediabox]").on("click",function(e){return e.preventDefault(),t.start(g.one(e.currentTarget)),!1})},enablenav:function(){var t=this;this.keyboardnav=g.one(document).on("keyup",function(e){t.keyboardaction(e)})},keyboardaction:function(e){var e=e.keyCode,t=String.fromCharCode(e).toLowerCase();27===e||t.match(/x|o|c/)?this.stop():"p"===t||37===e?0!==this.currentitemindex&&this.changeitem(this.currentitemindex-1):"n"!==t&&39!==e||this.currentitemindex!==this.album.length-1&&this.changeitem(this.currentitemindex+1)},repositionitem:function(e,t){var i,a,m,n,o,d="",c="",l=g.one("#mediabox-content"),r=l.get("children").get(0)[0],u=1,s="",b=M.util.get_string("thisdirection","core_langconfig");null!==this.currentitem&&(u=this.currentitem.getAttribute("data-player"),s=this.currentitem.getAttribute("data-type")),r!==undefined&&("2"===u||"youtube"===s?t=l.one(".mediaplugin.flow")?(e=this._videowidth,this._videoheight):(e=r.get("offsetWidth"),r.get("offsetHeight")):"0"===u?(e=this._audiowidth,t=this._audioheight):e===undefined&&(e=r.get("naturalWidth"),t=r.get("naturalHeight")),s=g.one("body").get("winWidth"),m=g.one("body").get("winHeight"),n=s-this.sidebarwidth(),o=m-this._navbarheight,n<e||o<t?(t/o<e/n?(d=n,a=0,i=(m-(c=parseInt(t/(e/n),10)))/2):(c=o,i=0,a=(s-(d=parseInt(e/(t/o),10))-this.sidebarwidth())/2),d+="px",c+="px"):(a=(s-e-this.sidebarwidth())/2,i=(m-t-this._navbarheight)/2),r.setStyle("width",d),r.setStyle("height",c),"0"===u&&l.one(".mediaplugin object")&&l.one(".mediaplugin object").setStyle("width",d),l.setStyle("top",i+"px"),"ltr"===b?l.setStyle("left",a+"px"):l.setStyle("right",a+"px"))},resizeoverlay:function(){var e=g.one("body").get("docWidth"),t=g.one("body").get("docHeight");this.overlay.setStyle("width",e),this.overlay.setStyle("height",t)},sidebarwidth:function(){return this.mediabox.hasClass("sidebarhidden")?0:this._sidebarwidth},start:function(e){var t,i,a=this;for(g.on("windowresize",function(){a.resizeoverlay(),a.repositionitem()}),g.one("body").addClass("noscroll mediaboxactive"),this.overlay.setStyle("display","block"),this.mediabox.setStyle("display","block"),i=t=0;i<this.album.length;i++)this.album[i].getAttribute("href")===e.getAttribute("href")&&(t=i);this.currentitemindex!==t&&g.one("#mediabox-content").empty(),this.setfullscreenimg(),this.changeitem(t),this.enablenav()},setfullscreenimg:function(){var e;g.one("#mediabox-sidebar-actions .fullscreen")&&(e=M.util.image_url("fullscreen","mod_mediagallery"),screenfull.isFullscreen&&(e=M.util.image_url("fullscreenexit","mod_mediagallery")),g.one("#mediabox-sidebar-actions .fullscreen").setAttribute("src",e))},setup_info_toggle:function(){var e,t,i=M.util.get_string("mediainformation","mod_mediagallery"),a=M.util.image_url("t/collapsed","moodle"),n=M.util.image_url("t/expanded","moodle"),o=g.Node.create('<img title="'+i+'"/>');o.setAttribute("src",a),(i=g.Node.create('<a href="#" class="toggle">'+i+"</a>")).prepend(o),(e=g.Node.create('<div class="metainfo-toggle"></div>')).prepend(i),g.one("#mediabox-sidebar").insertBefore(e,g.one("#mediabox-metainfo")),(t=g.one("#mediabox-metainfo")).toggleView(),g.delegate("click",function(e){e.preventDefault(),"hidden"===t.getAttribute("hidden")?o.setAttribute("src",n):o.setAttribute("src",a),t.toggleView()},"#mediabox","#mediabox-sidebar .metainfo-toggle a.toggle")},stop:function(){screenfull.isFullscreen&&screenfull.exit(),this.disablenav(),g.one("body").removeClass("noscroll mediaboxactive"),this.overlay.setStyle("display",""),this.mediabox.setStyle("display","")},update_likes:function(e,t){var i="";0<e&&(i="&nbsp;&bull;&nbsp;",i+=M.str.mod_mediagallery.likedby+": ",t&&(e-=1,i+=M.str.mod_mediagallery.you+", "),i=(i+=e+" ")+(
1!==e?M.str.mod_mediagallery.others:M.str.mod_mediagallery.other)),g.one("#mediabox-likedby").setHTML(i)}},{NAME:"moodle-mod_mediagallery-mediabox",ATTRS:{enablecomments:{value:!0,validator:function(e){return g.Lang.isBoolean(e)}},enablelikes:{value:!0,validator:function(e){return g.Lang.isBoolean(e)}},metainfouri:{value:"",validator:function(e){return g.Lang.isString(e)}},dataidfield:{value:"data-id",validator:function(e){return g.Lang.isString(e)}},metainfodata:{value:{},validator:function(e){return g.Lang.isObject(e)}}}}),M.mod_mediagallery=M.mod_mediagallery||{},M.mod_mediagallery.init_mediabox=function(e){return new t(e)}},"@VERSION@",{requires:["base","node","selector-css3"]});